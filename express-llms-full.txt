---
url: https://expressjs.com
description: Express.js æ˜¯ä¸€ä¸ªå¿«é€Ÿã€å¼€æ”¾ã€æç®€çš„ Node.js Web åº”ç”¨æ¡†æ¶ã€‚å®ƒæä¾›äº†å¼ºå¤§çš„è·¯ç”±ç³»ç»Ÿã€ä¸­é—´ä»¶æ”¯æŒã€æ¨¡æ¿å¼•æ“é›†æˆç­‰åŠŸèƒ½ï¼Œæ˜¯æ„å»º Web åº”ç”¨å’Œ API çš„é¦–é€‰æ¡†æ¶ã€‚
---

# Express.js å®Œæ•´æ–‡æ¡£

## ç®€ä»‹

Express.js æ˜¯ä¸€ä¸ªåŸºäº Node.js çš„è½»é‡çº§ Web åº”ç”¨æ¡†æ¶ï¼Œæä¾›äº†ä¸€ç³»åˆ—å¼ºå¤§çš„ç‰¹æ€§ï¼š

- **è·¯ç”±ç³»ç»Ÿ**: çµæ´»çš„è·¯ç”±å®šä¹‰å’Œå‚æ•°å¤„ç†
- **ä¸­é—´ä»¶**: å¯ç»„åˆçš„è¯·æ±‚å¤„ç†ç®¡é“
- **æ¨¡æ¿å¼•æ“**: æ”¯æŒå¤šç§è§†å›¾å¼•æ“
- **é™æ€æ–‡ä»¶æœåŠ¡**: å†…ç½®é™æ€æ–‡ä»¶æ‰˜ç®¡
- **é”™è¯¯å¤„ç†**: ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶
- **æ‰©å±•æ€§**: ä¸°å¯Œçš„ä¸­é—´ä»¶ç”Ÿæ€ç³»ç»Ÿ

## å¿«é€Ÿå¼€å§‹

### å®‰è£…

```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir myapp
cd myapp

# åˆå§‹åŒ– package.json
npm init -y

# å®‰è£… Express
npm install express
```

### åŸºæœ¬åº”ç”¨

```javascript
const express = require('express')
const app = express()
const port = 3000

app.get('/', (req, res) => {
  res.send('Hello World!')
})

app.listen(port, () => {
  console.log(`Server listening on port ${port}`)
})
```

### ä½¿ç”¨ Express Generator

```bash
# å®‰è£…ç”Ÿæˆå™¨
npm install -g express-generator

# åˆ›å»ºåº”ç”¨
express --view=pug myapp

# å®‰è£…ä¾èµ–å¹¶å¯åŠ¨
cd myapp
npm install
npm start
```

### é¡¹ç›®ç»“æ„

```
myapp/
â”œâ”€â”€ bin/
â”‚   â””â”€â”€ www              # å¯åŠ¨è„šæœ¬
â”œâ”€â”€ public/              # é™æ€èµ„æº
â”‚   â”œâ”€â”€ images/
â”‚   â”œâ”€â”€ javascripts/
â”‚   â””â”€â”€ stylesheets/
â”œâ”€â”€ routes/              # è·¯ç”±æ–‡ä»¶
â”‚   â”œâ”€â”€ index.js
â”‚   â””â”€â”€ users.js
â”œâ”€â”€ views/               # æ¨¡æ¿æ–‡ä»¶
â”‚   â”œâ”€â”€ error.pug
â”‚   â”œâ”€â”€ index.pug
â”‚   â””â”€â”€ layout.pug
â”œâ”€â”€ app.js               # åº”ç”¨å…¥å£
â””â”€â”€ package.json
```

## è·¯ç”±

### åŸºæœ¬è·¯ç”±

```javascript
const express = require('express')
const app = express()

// GET è¯·æ±‚
app.get('/', (req, res) => {
  res.send('GET request to homepage')
})

// POST è¯·æ±‚
app.post('/', (req, res) => {
  res.send('POST request to homepage')
})

// PUT è¯·æ±‚
app.put('/user', (req, res) => {
  res.send('PUT request to /user')
})

// DELETE è¯·æ±‚
app.delete('/user', (req, res) => {
  res.send('DELETE request to /user')
})

// PATCH è¯·æ±‚
app.patch('/user', (req, res) => {
  res.send('PATCH request to /user')
})

// æ‰€æœ‰ HTTP æ–¹æ³•
app.all('/secret', (req, res, next) => {
  console.log('Accessing the secret section...')
  next()
})
```

### è·¯ç”±è·¯å¾„

```javascript
// å­—ç¬¦ä¸²è·¯å¾„
app.get('/about', (req, res) => {
  res.send('About page')
})

// å­—ç¬¦ä¸²æ¨¡å¼
app.get('/ab?cd', (req, res) => {
  // åŒ¹é… /acd å’Œ /abcd
  res.send('ab?cd')
})

app.get('/ab+cd', (req, res) => {
  // åŒ¹é… /abcd, /abbcd, /abbbcd ç­‰
  res.send('ab+cd')
})

app.get('/ab*cd', (req, res) => {
  // åŒ¹é… /abcd, /abxcd, /abRANDOMcd ç­‰
  res.send('ab*cd')
})

app.get('/ab(cd)?e', (req, res) => {
  // åŒ¹é… /abe å’Œ /abcde
  res.send('ab(cd)?e')
})

// æ­£åˆ™è¡¨è¾¾å¼
app.get(/a/, (req, res) => {
  // åŒ¹é…åŒ…å« 'a' çš„è·¯å¾„
  res.send('/a/')
})

app.get(/.*fly$/, (req, res) => {
  // åŒ¹é…ä»¥ 'fly' ç»“å°¾çš„è·¯å¾„
  res.send('/.*fly$/')
})
```

### è·¯ç”±å‚æ•°

```javascript
// åŸºæœ¬å‚æ•°
app.get('/users/:userId', (req, res) => {
  res.send(`User ID: ${req.params.userId}`)
})

// å¤šä¸ªå‚æ•°
app.get('/users/:userId/books/:bookId', (req, res) => {
  res.send(`User: ${req.params.userId}, Book: ${req.params.bookId}`)
})

// å¸¦çº¦æŸçš„å‚æ•°
app.get('/users/:userId(\\d+)', (req, res) => {
  // åªåŒ¹é…æ•°å­—
  res.send(`User ID: ${req.params.userId}`)
})

// å¯é€‰å‚æ•°
app.get('/users/:userId?', (req, res) => {
  if (req.params.userId) {
    res.send(`User ID: ${req.params.userId}`)
  } else {
    res.send('All users')
  }
})
```

### è·¯ç”±å¤„ç†å™¨

```javascript
// å•ä¸ªå›è°ƒå‡½æ•°
app.get('/example/a', (req, res) => {
  res.send('Hello from A!')
})

// å¤šä¸ªå›è°ƒå‡½æ•°
app.get('/example/b', (req, res, next) => {
  console.log('First callback')
  next()
}, (req, res) => {
  res.send('Hello from B!')
})

// å›è°ƒå‡½æ•°æ•°ç»„
const cb0 = (req, res, next) => {
  console.log('CB0')
  next()
}

const cb1 = (req, res, next) => {
  console.log('CB1')
  next()
}

const cb2 = (req, res) => {
  res.send('Hello from C!')
}

app.get('/example/c', [cb0, cb1, cb2])

// æ··åˆä½¿ç”¨
app.get('/example/d', [cb0, cb1], (req, res, next) => {
  console.log('Response will be sent by the next function')
  next()
}, (req, res) => {
  res.send('Hello from D!')
})
```

### é“¾å¼è·¯ç”±

```javascript
app.route('/book')
  .get((req, res) => {
    res.send('Get a random book')
  })
  .post((req, res) => {
    res.send('Add a book')
  })
  .put((req, res) => {
    res.send('Update the book')
  })
  .delete((req, res) => {
    res.send('Delete the book')
  })
```

### express.Router

```javascript
// routes/birds.js
const express = require('express')
const router = express.Router()

// è·¯ç”±çº§ä¸­é—´ä»¶
router.use((req, res, next) => {
  console.log('Time:', Date.now())
  next()
})

// å®šä¹‰è·¯ç”±
router.get('/', (req, res) => {
  res.send('Birds home page')
})

router.get('/about', (req, res) => {
  res.send('About birds')
})

router.get('/:id', (req, res) => {
  res.send(`Bird ID: ${req.params.id}`)
})

module.exports = router

// app.js
const express = require('express')
const app = express()
const birdsRouter = require('./routes/birds')

// æŒ‚è½½è·¯ç”±
app.use('/birds', birdsRouter)
```

### è·¯ç”±å‚æ•°å¤„ç†

```javascript
const express = require('express')
const router = express.Router()

// å‚æ•°é¢„å¤„ç†ä¸­é—´ä»¶
router.param('userId', (req, res, next, id) => {
  // éªŒè¯å’ŒåŠ è½½ç”¨æˆ·
  const user = getUserById(id)
  if (!user) {
    return res.status(404).send('User not found')
  }
  req.user = user
  next()
})

router.get('/users/:userId', (req, res) => {
  res.json(req.user)
})

router.put('/users/:userId', (req, res) => {
  // req.user å·²ç»å¯ç”¨
  updateUser(req.user, req.body)
  res.json(req.user)
})
```

## ä¸­é—´ä»¶

### åº”ç”¨çº§ä¸­é—´ä»¶

```javascript
const express = require('express')
const app = express()

// æ— æŒ‚è½½è·¯å¾„ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½æ‰§è¡Œ
app.use((req, res, next) => {
  console.log('Time:', Date.now())
  next()
})

// æŒ‚è½½åˆ°ç‰¹å®šè·¯å¾„
app.use('/user/:id', (req, res, next) => {
  console.log('Request Type:', req.method)
  next()
})

// é’ˆå¯¹ç‰¹å®šè·¯å¾„å’Œæ–¹æ³•
app.get('/user/:id', (req, res, next) => {
  res.send('USER')
})

// å¤šä¸ªå¤„ç†å‡½æ•°
app.use('/user/:id', (req, res, next) => {
  console.log('Request URL:', req.originalUrl)
  next()
}, (req, res, next) => {
  console.log('Request Type:', req.method)
  next()
})
```

### è·¯ç”±çº§ä¸­é—´ä»¶

```javascript
const express = require('express')
const router = express.Router()

// æ— æŒ‚è½½è·¯å¾„
router.use((req, res, next) => {
  console.log('Time:', Date.now())
  next()
})

// æŒ‚è½½åˆ°ç‰¹å®šè·¯å¾„
router.use('/user/:id', (req, res, next) => {
  console.log('Request URL:', req.originalUrl)
  next()
}, (req, res, next) => {
  console.log('Request Type:', req.method)
  next()
})

// è·³è¿‡å‰©ä½™ä¸­é—´ä»¶
router.get('/user/:id', (req, res, next) => {
  if (req.params.id === '0') next('route')
  else next()
}, (req, res, next) => {
  res.send('regular')
})

// å¤„ç†ç‰¹æ®Šæƒ…å†µ
router.get('/user/:id', (req, res, next) => {
  res.send('special')
})

module.exports = router
```

### é”™è¯¯å¤„ç†ä¸­é—´ä»¶

```javascript
const express = require('express')
const app = express()

// æ™®é€šè·¯ç”±
app.get('/', (req, res, next) => {
  // æ¨¡æ‹Ÿé”™è¯¯
  const err = new Error('Something went wrong')
  next(err)
})

// é”™è¯¯æ—¥å¿—ä¸­é—´ä»¶
function logErrors(err, req, res, next) {
  console.error(err.stack)
  next(err)
}

// å®¢æˆ·ç«¯é”™è¯¯å¤„ç†
function clientErrorHandler(err, req, res, next) {
  if (req.xhr) {
    res.status(500).send({ error: 'Something failed!' })
  } else {
    next(err)
  }
}

// å…œåº•é”™è¯¯å¤„ç†
function errorHandler(err, req, res, next) {
  res.status(500)
  res.render('error', { error: err })
}

// æ³¨å†Œé”™è¯¯å¤„ç†ä¸­é—´ä»¶ï¼ˆå¿…é¡»æ”¾åœ¨æœ€åï¼‰
app.use(logErrors)
app.use(clientErrorHandler)
app.use(errorHandler)
```

### å†…ç½®ä¸­é—´ä»¶

```javascript
const express = require('express')
const app = express()

// è§£æ JSON è¯·æ±‚ä½“
app.use(express.json())

// è§£æ URL ç¼–ç çš„è¯·æ±‚ä½“
app.use(express.urlencoded({ extended: true }))

// æä¾›é™æ€æ–‡ä»¶
app.use(express.static('public'))

// å¤šä¸ªé™æ€ç›®å½•
app.use(express.static('public'))
app.use(express.static('files'))

// è™šæ‹Ÿè·¯å¾„å‰ç¼€
app.use('/static', express.static('public'))

// å¸¦é€‰é¡¹çš„é™æ€æ–‡ä»¶æœåŠ¡
const options = {
  dotfiles: 'ignore',
  etag: false,
  extensions: ['htm', 'html'],
  index: false,
  maxAge: '1d',
  redirect: false,
  setHeaders: (res, path, stat) => {
    res.set('x-timestamp', Date.now())
  }
}

app.use(express.static('public', options))
```

### ç¬¬ä¸‰æ–¹ä¸­é—´ä»¶

```javascript
const express = require('express')
const app = express()

// Cookie è§£æ
const cookieParser = require('cookie-parser')
app.use(cookieParser())

// ä¼šè¯ç®¡ç†
const session = require('express-session')
app.use(session({
  secret: 'keyboard cat',
  resave: false,
  saveUninitialized: true,
  cookie: { secure: true }
}))

// CORS
const cors = require('cors')
app.use(cors())

// å‹ç¼©
const compression = require('compression')
app.use(compression())

// æ—¥å¿—
const morgan = require('morgan')
app.use(morgan('combined'))

// å®‰å…¨å¤´
const helmet = require('helmet')
app.use(helmet())
```

## è¯·æ±‚å¯¹è±¡ (req)

### å¸¸ç”¨å±æ€§

```javascript
app.get('/users/:id', (req, res) => {
  // è·¯ç”±å‚æ•°
  console.log(req.params.id)

  // æŸ¥è¯¢å­—ç¬¦ä¸² (?name=john&age=30)
  console.log(req.query.name)
  console.log(req.query.age)

  // è¯·æ±‚ä½“ï¼ˆéœ€è¦ body-parserï¼‰
  console.log(req.body)

  // è¯·æ±‚å¤´
  console.log(req.headers)
  console.log(req.get('Content-Type'))

  // HTTP æ–¹æ³•
  console.log(req.method)

  // è¯·æ±‚è·¯å¾„
  console.log(req.path)

  // åŸå§‹ URL
  console.log(req.originalUrl)

  // åè®®
  console.log(req.protocol)

  // ä¸»æœºå
  console.log(req.hostname)

  // IP åœ°å€
  console.log(req.ip)
  console.log(req.ips)

  // æ˜¯å¦ HTTPS
  console.log(req.secure)

  // æ˜¯å¦ XHR è¯·æ±‚
  console.log(req.xhr)

  // Cookiesï¼ˆéœ€è¦ cookie-parserï¼‰
  console.log(req.cookies)
  console.log(req.signedCookies)

  res.send('OK')
})
```

### è¯·æ±‚ä½“è§£æ

```javascript
const express = require('express')
const app = express()

// JSON è¯·æ±‚ä½“
app.use(express.json({
  limit: '100kb',
  strict: true,
  type: 'application/json'
}))

// URL ç¼–ç è¯·æ±‚ä½“
app.use(express.urlencoded({
  extended: true,
  limit: '100kb'
}))

app.post('/api/users', (req, res) => {
  console.log(req.body)
  res.json(req.body)
})
```

### æ–‡ä»¶ä¸Šä¼ 

```javascript
const express = require('express')
const multer = require('multer')
const app = express()

// é…ç½®å­˜å‚¨
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, 'uploads/')
  },
  filename: (req, file, cb) => {
    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9)
    cb(null, file.fieldname + '-' + uniqueSuffix)
  }
})

const upload = multer({
  storage: storage,
  limits: {
    fileSize: 5 * 1024 * 1024 // 5MB
  },
  fileFilter: (req, file, cb) => {
    if (file.mimetype.startsWith('image/')) {
      cb(null, true)
    } else {
      cb(new Error('Only images are allowed'), false)
    }
  }
})

// å•æ–‡ä»¶ä¸Šä¼ 
app.post('/upload', upload.single('avatar'), (req, res) => {
  console.log(req.file)
  res.json({ file: req.file })
})

// å¤šæ–‡ä»¶ä¸Šä¼ 
app.post('/photos', upload.array('photos', 12), (req, res) => {
  console.log(req.files)
  res.json({ files: req.files })
})

// å¤šå­—æ®µä¸Šä¼ 
app.post('/profile', upload.fields([
  { name: 'avatar', maxCount: 1 },
  { name: 'gallery', maxCount: 8 }
]), (req, res) => {
  console.log(req.files)
  res.json({ files: req.files })
})

// é”™è¯¯å¤„ç†
app.post('/upload', (req, res) => {
  upload.single('avatar')(req, res, (err) => {
    if (err instanceof multer.MulterError) {
      return res.status(400).json({ error: err.message })
    } else if (err) {
      return res.status(400).json({ error: err.message })
    }
    res.json({ file: req.file })
  })
})
```

## å“åº”å¯¹è±¡ (res)

### å‘é€å“åº”

```javascript
app.get('/api', (req, res) => {
  // å‘é€å­—ç¬¦ä¸²
  res.send('Hello World')

  // å‘é€ JSON
  res.json({ message: 'Hello' })

  // å‘é€çŠ¶æ€ç 
  res.sendStatus(200) // ç­‰åŒäº res.status(200).send('OK')
  res.sendStatus(404) // Not Found
  res.sendStatus(500) // Internal Server Error

  // å‘é€æ–‡ä»¶
  res.sendFile('/path/to/file.pdf')

  // ä¸‹è½½æ–‡ä»¶
  res.download('/path/to/file.pdf', 'report.pdf')

  // é‡å®šå‘
  res.redirect('/login')
  res.redirect(301, '/new-url')
  res.redirect('back')

  // æ¸²æŸ“æ¨¡æ¿
  res.render('index', { title: 'Hello' })

  // ç»“æŸå“åº”
  res.end()
})
```

### è®¾ç½®å“åº”

```javascript
app.get('/api', (req, res) => {
  // è®¾ç½®çŠ¶æ€ç 
  res.status(201)

  // è®¾ç½®å¤´éƒ¨
  res.set('Content-Type', 'text/plain')
  res.set({
    'Content-Type': 'text/plain',
    'X-Custom-Header': 'value'
  })

  // æ·»åŠ å¤´éƒ¨
  res.append('Link', ['<http://localhost/>', '<http://localhost:3000/>'])

  // è®¾ç½® Cookie
  res.cookie('name', 'value', {
    maxAge: 900000,
    httpOnly: true,
    secure: true,
    sameSite: 'lax'
  })

  // æ¸…é™¤ Cookie
  res.clearCookie('name')

  // è®¾ç½®å†…å®¹ç±»å‹
  res.type('json')
  res.type('application/json')

  // è®¾ç½®é“¾æ¥å¤´
  res.links({
    next: 'http://api.example.com/users?page=2',
    last: 'http://api.example.com/users?page=5'
  })

  res.json({ message: 'OK' })
})
```

### å†…å®¹åå•†

```javascript
app.get('/api/data', (req, res) => {
  res.format({
    'text/plain': () => {
      res.send('Hello World')
    },
    'text/html': () => {
      res.send('<p>Hello World</p>')
    },
    'application/json': () => {
      res.json({ message: 'Hello World' })
    },
    default: () => {
      res.status(406).send('Not Acceptable')
    }
  })
})
```

### æµå¼å“åº”

```javascript
const fs = require('fs')

app.get('/video', (req, res) => {
  const path = '/path/to/video.mp4'
  const stat = fs.statSync(path)
  const fileSize = stat.size
  const range = req.headers.range

  if (range) {
    const parts = range.replace(/bytes=/, '').split('-')
    const start = parseInt(parts[0], 10)
    const end = parts[1] ? parseInt(parts[1], 10) : fileSize - 1
    const chunksize = (end - start) + 1
    const file = fs.createReadStream(path, { start, end })

    res.writeHead(206, {
      'Content-Range': `bytes ${start}-${end}/${fileSize}`,
      'Accept-Ranges': 'bytes',
      'Content-Length': chunksize,
      'Content-Type': 'video/mp4',
    })

    file.pipe(res)
  } else {
    res.writeHead(200, {
      'Content-Length': fileSize,
      'Content-Type': 'video/mp4',
    })
    fs.createReadStream(path).pipe(res)
  }
})
```

## æ¨¡æ¿å¼•æ“

### é…ç½®æ¨¡æ¿å¼•æ“

```javascript
const express = require('express')
const path = require('path')
const app = express()

// è®¾ç½®è§†å›¾ç›®å½•
app.set('views', path.join(__dirname, 'views'))

// è®¾ç½®æ¨¡æ¿å¼•æ“
app.set('view engine', 'pug')

// æ¸²æŸ“æ¨¡æ¿
app.get('/', (req, res) => {
  res.render('index', {
    title: 'Hello',
    message: 'Welcome to Express'
  })
})
```

### Pug æ¨¡æ¿

```pug
//- views/layout.pug
doctype html
html
  head
    title= title
    link(rel='stylesheet', href='/stylesheets/style.css')
  body
    block content

//- views/index.pug
extends layout

block content
  h1= message
  p Welcome to #{title}
```

### EJS æ¨¡æ¿

```javascript
// é…ç½® EJS
app.set('view engine', 'ejs')
```

```html
<!-- views/index.ejs -->
<!DOCTYPE html>
<html>
<head>
  <title><%= title %></title>
</head>
<body>
  <h1><%= message %></h1>
  <ul>
    <% users.forEach(function(user) { %>
      <li><%= user.name %></li>
    <% }); %>
  </ul>
</body>
</html>
```

### è‡ªå®šä¹‰æ¨¡æ¿å¼•æ“

```javascript
const fs = require('fs')

// æ³¨å†Œè‡ªå®šä¹‰æ¨¡æ¿å¼•æ“
app.engine('ntl', (filePath, options, callback) => {
  fs.readFile(filePath, (err, content) => {
    if (err) return callback(err)

    const rendered = content.toString()
      .replace('#title#', `<title>${options.title}</title>`)
      .replace('#message#', `<h1>${options.message}</h1>`)

    return callback(null, rendered)
  })
})

app.set('views', './views')
app.set('view engine', 'ntl')
```

## é”™è¯¯å¤„ç†

### åŸºæœ¬é”™è¯¯å¤„ç†

```javascript
const express = require('express')
const app = express()

// åŒæ­¥é”™è¯¯ä¼šè‡ªåŠ¨æ•è·
app.get('/sync-error', (req, res) => {
  throw new Error('Sync error!')
})

// å¼‚æ­¥é”™è¯¯éœ€è¦ä¼ é€’ç»™ next
app.get('/async-error', (req, res, next) => {
  fs.readFile('/file-does-not-exist', (err, data) => {
    if (err) {
      next(err)
    } else {
      res.send(data)
    }
  })
})

// Express 5+ è‡ªåŠ¨å¤„ç† Promise é”™è¯¯
app.get('/promise-error', async (req, res, next) => {
  const user = await getUserById(req.params.id)
  res.json(user)
})

// 404 å¤„ç†
app.use((req, res, next) => {
  res.status(404).send("Sorry, can't find that!")
})

// é”™è¯¯å¤„ç†ä¸­é—´ä»¶
app.use((err, req, res, next) => {
  console.error(err.stack)
  res.status(500).send('Something broke!')
})
```

### è‡ªå®šä¹‰é”™è¯¯ç±»

```javascript
// è‡ªå®šä¹‰é”™è¯¯ç±»
class AppError extends Error {
  constructor(message, statusCode) {
    super(message)
    this.statusCode = statusCode
    this.status = `${statusCode}`.startsWith('4') ? 'fail' : 'error'
    this.isOperational = true

    Error.captureStackTrace(this, this.constructor)
  }
}

// ä½¿ç”¨è‡ªå®šä¹‰é”™è¯¯
app.get('/user/:id', async (req, res, next) => {
  const user = await User.findById(req.params.id)
  if (!user) {
    return next(new AppError('User not found', 404))
  }
  res.json(user)
})

// é”™è¯¯å¤„ç†ä¸­é—´ä»¶
app.use((err, req, res, next) => {
  err.statusCode = err.statusCode || 500
  err.status = err.status || 'error'

  if (process.env.NODE_ENV === 'development') {
    res.status(err.statusCode).json({
      status: err.status,
      error: err,
      message: err.message,
      stack: err.stack
    })
  } else {
    if (err.isOperational) {
      res.status(err.statusCode).json({
        status: err.status,
        message: err.message
      })
    } else {
      console.error('ERROR ğŸ’¥', err)
      res.status(500).json({
        status: 'error',
        message: 'Something went wrong!'
      })
    }
  }
})
```

### å¼‚æ­¥é”™è¯¯åŒ…è£…å™¨

```javascript
// å¼‚æ­¥é”™è¯¯åŒ…è£…å™¨
const catchAsync = fn => {
  return (req, res, next) => {
    fn(req, res, next).catch(next)
  }
}

// ä½¿ç”¨åŒ…è£…å™¨
app.get('/users', catchAsync(async (req, res, next) => {
  const users = await User.find()
  res.json(users)
}))

app.post('/users', catchAsync(async (req, res, next) => {
  const user = await User.create(req.body)
  res.status(201).json(user)
}))
```

## ä¼šè¯ç®¡ç†

### express-session

```javascript
const express = require('express')
const session = require('express-session')
const app = express()

app.use(session({
  secret: 'your-secret-key',
  resave: false,
  saveUninitialized: false,
  cookie: {
    secure: process.env.NODE_ENV === 'production',
    httpOnly: true,
    maxAge: 24 * 60 * 60 * 1000 // 24å°æ—¶
  }
}))

// ä½¿ç”¨ä¼šè¯
app.get('/login', (req, res) => {
  req.session.user = { id: 1, name: 'John' }
  res.send('Logged in')
})

app.get('/profile', (req, res) => {
  if (req.session.user) {
    res.json(req.session.user)
  } else {
    res.status(401).send('Not logged in')
  }
})

app.get('/logout', (req, res) => {
  req.session.destroy(err => {
    if (err) {
      return res.status(500).send('Error logging out')
    }
    res.redirect('/')
  })
})
```

### ä¼šè¯å­˜å‚¨

```javascript
const session = require('express-session')
const MongoStore = require('connect-mongo')
const RedisStore = require('connect-redis').default
const { createClient } = require('redis')

// MongoDB å­˜å‚¨
app.use(session({
  secret: 'secret',
  resave: false,
  saveUninitialized: false,
  store: MongoStore.create({
    mongoUrl: 'mongodb://localhost/sessions',
    ttl: 14 * 24 * 60 * 60 // 14å¤©
  })
}))

// Redis å­˜å‚¨
const redisClient = createClient()
redisClient.connect()

app.use(session({
  secret: 'secret',
  resave: false,
  saveUninitialized: false,
  store: new RedisStore({
    client: redisClient,
    prefix: 'sess:'
  })
}))
```

### ç™»å½•ç¤ºä¾‹

```javascript
const express = require('express')
const session = require('express-session')
const escapeHtml = require('escape-html')
const app = express()

app.use(express.urlencoded({ extended: false }))
app.use(session({
  secret: 'keyboard cat',
  resave: false,
  saveUninitialized: true
}))

// è®¤è¯ä¸­é—´ä»¶
function isAuthenticated(req, res, next) {
  if (req.session.user) next()
  else next('route')
}

// é¦–é¡µ
app.get('/', isAuthenticated, (req, res) => {
  res.send(`Hello, ${escapeHtml(req.session.user)}! <a href="/logout">Logout</a>`)
})

app.get('/', (req, res) => {
  res.send(`
    <form action="/login" method="post">
      Username: <input name="user"><br>
      Password: <input name="pass" type="password"><br>
      <input type="submit" value="Login">
    </form>
  `)
})

// ç™»å½•
app.post('/login', (req, res, next) => {
  // éªŒè¯ç”¨æˆ·ï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼‰
  if (req.body.user && req.body.pass) {
    req.session.regenerate(err => {
      if (err) return next(err)

      req.session.user = req.body.user

      req.session.save(err => {
        if (err) return next(err)
        res.redirect('/')
      })
    })
  } else {
    res.status(400).send('Invalid credentials')
  }
})

// ç™»å‡º
app.get('/logout', (req, res, next) => {
  req.session.user = null
  req.session.save(err => {
    if (err) return next(err)

    req.session.regenerate(err => {
      if (err) return next(err)
      res.redirect('/')
    })
  })
})
```

## å®‰å…¨æœ€ä½³å®è·µ

### Helmet å®‰å…¨å¤´

```javascript
const express = require('express')
const helmet = require('helmet')
const app = express()

// ä½¿ç”¨æ‰€æœ‰å®‰å…¨å¤´
app.use(helmet())

// æˆ–è€…å•ç‹¬é…ç½®
app.use(helmet.contentSecurityPolicy({
  directives: {
    defaultSrc: ["'self'"],
    styleSrc: ["'self'", 'maxcdn.bootstrapcdn.com']
  }
}))

app.use(helmet.dnsPrefetchControl())
app.use(helmet.expectCt())
app.use(helmet.frameguard())
app.use(helmet.hidePoweredBy())
app.use(helmet.hsts())
app.use(helmet.ieNoOpen())
app.use(helmet.noSniff())
app.use(helmet.permittedCrossDomainPolicies())
app.use(helmet.referrerPolicy())
app.use(helmet.xssFilter())
```

### CORS é…ç½®

```javascript
const express = require('express')
const cors = require('cors')
const app = express()

// ç®€å•ä½¿ç”¨
app.use(cors())

// è¯¦ç»†é…ç½®
const corsOptions = {
  origin: function (origin, callback) {
    const whitelist = ['http://localhost:3000', 'https://myapp.com']
    if (!origin || whitelist.indexOf(origin) !== -1) {
      callback(null, true)
    } else {
      callback(new Error('Not allowed by CORS'))
    }
  },
  methods: ['GET', 'POST', 'PUT', 'DELETE'],
  allowedHeaders: ['Content-Type', 'Authorization'],
  credentials: true,
  maxAge: 86400
}

app.use(cors(corsOptions))

// é’ˆå¯¹ç‰¹å®šè·¯ç”±
app.get('/api/public', cors(), (req, res) => {
  res.json({ message: 'Public data' })
})

// é¢„æ£€è¯·æ±‚
app.options('/api/data', cors())
app.put('/api/data', cors(), (req, res) => {
  res.json({ message: 'Data updated' })
})
```

### é€Ÿç‡é™åˆ¶

```javascript
const express = require('express')
const rateLimit = require('express-rate-limit')
const app = express()

// å…¨å±€é€Ÿç‡é™åˆ¶
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15åˆ†é’Ÿ
  max: 100, // æ¯ä¸ª IP æœ€å¤š 100 ä¸ªè¯·æ±‚
  message: 'Too many requests, please try again later.',
  standardHeaders: true,
  legacyHeaders: false,
})

app.use(limiter)

// API ç‰¹å®šé™åˆ¶
const apiLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 50,
  message: { error: 'Too many API requests' }
})

app.use('/api/', apiLimiter)

// ç™»å½•é™åˆ¶
const loginLimiter = rateLimit({
  windowMs: 60 * 60 * 1000, // 1å°æ—¶
  max: 5,
  message: 'Too many login attempts'
})

app.post('/login', loginLimiter, (req, res) => {
  // ç™»å½•é€»è¾‘
})
```

### è¾“å…¥éªŒè¯

```javascript
const express = require('express')
const { body, validationResult } = require('express-validator')
const app = express()

app.use(express.json())

app.post('/user',
  // éªŒè¯è§„åˆ™
  body('email').isEmail().normalizeEmail(),
  body('password').isLength({ min: 8 }),
  body('name').trim().escape(),
  body('age').optional().isInt({ min: 0 }),

  (req, res) => {
    const errors = validationResult(req)
    if (!errors.isEmpty()) {
      return res.status(400).json({ errors: errors.array() })
    }

    // å¤„ç†éªŒè¯åçš„æ•°æ®
    const { email, password, name, age } = req.body
    res.json({ email, name, age })
  }
)
```

### Cookie å®‰å…¨

```javascript
const express = require('express')
const cookieParser = require('cookie-parser')
const app = express()

app.use(cookieParser('secret-key'))

// å®‰å…¨ Cookie è®¾ç½®
app.get('/set-cookie', (req, res) => {
  res.cookie('session', 'value', {
    httpOnly: true,    // é˜²æ­¢ XSS
    secure: true,      // ä»… HTTPS
    sameSite: 'strict', // é˜²æ­¢ CSRF
    maxAge: 3600000,   // 1å°æ—¶
    signed: true       // ç­¾å
  })
  res.send('Cookie set')
})

app.get('/get-cookie', (req, res) => {
  console.log(req.signedCookies.session)
  res.send('Cookie value: ' + req.signedCookies.session)
})
```

## æ•°æ®åº“é›†æˆ

### MySQL

```javascript
const express = require('express')
const mysql = require('mysql2/promise')
const app = express()

// åˆ›å»ºè¿æ¥æ± 
const pool = mysql.createPool({
  host: 'localhost',
  user: 'root',
  password: 'password',
  database: 'myapp',
  waitForConnections: true,
  connectionLimit: 10,
  queueLimit: 0
})

// ä½¿ç”¨è¿æ¥æ± 
app.get('/users', async (req, res) => {
  try {
    const [rows] = await pool.query('SELECT * FROM users')
    res.json(rows)
  } catch (err) {
    res.status(500).json({ error: err.message })
  }
})

app.get('/users/:id', async (req, res) => {
  try {
    const [rows] = await pool.query(
      'SELECT * FROM users WHERE id = ?',
      [req.params.id]
    )
    if (rows.length === 0) {
      return res.status(404).json({ error: 'User not found' })
    }
    res.json(rows[0])
  } catch (err) {
    res.status(500).json({ error: err.message })
  }
})

app.post('/users', async (req, res) => {
  try {
    const { name, email } = req.body
    const [result] = await pool.query(
      'INSERT INTO users (name, email) VALUES (?, ?)',
      [name, email]
    )
    res.status(201).json({ id: result.insertId, name, email })
  } catch (err) {
    res.status(500).json({ error: err.message })
  }
})
```

### MongoDB

```javascript
const express = require('express')
const mongoose = require('mongoose')
const app = express()

// è¿æ¥ MongoDB
mongoose.connect('mongodb://localhost/myapp', {
  useNewUrlParser: true,
  useUnifiedTopology: true
})

// å®šä¹‰ Schema
const userSchema = new mongoose.Schema({
  name: { type: String, required: true },
  email: { type: String, required: true, unique: true },
  createdAt: { type: Date, default: Date.now }
})

const User = mongoose.model('User', userSchema)

// è·¯ç”±
app.get('/users', async (req, res) => {
  try {
    const users = await User.find()
    res.json(users)
  } catch (err) {
    res.status(500).json({ error: err.message })
  }
})

app.post('/users', async (req, res) => {
  try {
    const user = new User(req.body)
    await user.save()
    res.status(201).json(user)
  } catch (err) {
    res.status(400).json({ error: err.message })
  }
})

app.put('/users/:id', async (req, res) => {
  try {
    const user = await User.findByIdAndUpdate(
      req.params.id,
      req.body,
      { new: true, runValidators: true }
    )
    if (!user) {
      return res.status(404).json({ error: 'User not found' })
    }
    res.json(user)
  } catch (err) {
    res.status(400).json({ error: err.message })
  }
})

app.delete('/users/:id', async (req, res) => {
  try {
    const user = await User.findByIdAndDelete(req.params.id)
    if (!user) {
      return res.status(404).json({ error: 'User not found' })
    }
    res.status(204).send()
  } catch (err) {
    res.status(500).json({ error: err.message })
  }
})
```

### PostgreSQL

```javascript
const express = require('express')
const { Pool } = require('pg')
const app = express()

const pool = new Pool({
  user: 'dbuser',
  host: 'localhost',
  database: 'myapp',
  password: 'password',
  port: 5432,
})

app.get('/users', async (req, res) => {
  try {
    const { rows } = await pool.query('SELECT * FROM users')
    res.json(rows)
  } catch (err) {
    res.status(500).json({ error: err.message })
  }
})

app.get('/users/:id', async (req, res) => {
  try {
    const { rows } = await pool.query(
      'SELECT * FROM users WHERE id = $1',
      [req.params.id]
    )
    if (rows.length === 0) {
      return res.status(404).json({ error: 'User not found' })
    }
    res.json(rows[0])
  } catch (err) {
    res.status(500).json({ error: err.message })
  }
})
```

## RESTful API è®¾è®¡

### å®Œæ•´çš„ CRUD ç¤ºä¾‹

```javascript
const express = require('express')
const router = express.Router()

// å‡è®¾çš„æ•°æ®å­˜å‚¨
let users = [
  { id: 1, name: 'John', email: 'john@example.com' },
  { id: 2, name: 'Jane', email: 'jane@example.com' }
]

// è·å–æ‰€æœ‰ç”¨æˆ·
router.get('/', (req, res) => {
  const { page = 1, limit = 10, sort, order = 'asc' } = req.query

  let result = [...users]

  // æ’åº
  if (sort) {
    result.sort((a, b) => {
      if (order === 'desc') {
        return b[sort] > a[sort] ? 1 : -1
      }
      return a[sort] > b[sort] ? 1 : -1
    })
  }

  // åˆ†é¡µ
  const startIndex = (page - 1) * limit
  const endIndex = page * limit
  const paginatedResult = result.slice(startIndex, endIndex)

  res.json({
    data: paginatedResult,
    pagination: {
      page: parseInt(page),
      limit: parseInt(limit),
      total: users.length,
      pages: Math.ceil(users.length / limit)
    }
  })
})

// è·å–å•ä¸ªç”¨æˆ·
router.get('/:id', (req, res) => {
  const user = users.find(u => u.id === parseInt(req.params.id))
  if (!user) {
    return res.status(404).json({ error: 'User not found' })
  }
  res.json(user)
})

// åˆ›å»ºç”¨æˆ·
router.post('/', (req, res) => {
  const { name, email } = req.body

  if (!name || !email) {
    return res.status(400).json({ error: 'Name and email are required' })
  }

  const newUser = {
    id: users.length + 1,
    name,
    email
  }

  users.push(newUser)
  res.status(201).json(newUser)
})

// æ›´æ–°ç”¨æˆ·
router.put('/:id', (req, res) => {
  const index = users.findIndex(u => u.id === parseInt(req.params.id))
  if (index === -1) {
    return res.status(404).json({ error: 'User not found' })
  }

  const { name, email } = req.body
  users[index] = { ...users[index], name, email }
  res.json(users[index])
})

// éƒ¨åˆ†æ›´æ–°ç”¨æˆ·
router.patch('/:id', (req, res) => {
  const index = users.findIndex(u => u.id === parseInt(req.params.id))
  if (index === -1) {
    return res.status(404).json({ error: 'User not found' })
  }

  users[index] = { ...users[index], ...req.body }
  res.json(users[index])
})

// åˆ é™¤ç”¨æˆ·
router.delete('/:id', (req, res) => {
  const index = users.findIndex(u => u.id === parseInt(req.params.id))
  if (index === -1) {
    return res.status(404).json({ error: 'User not found' })
  }

  users.splice(index, 1)
  res.status(204).send()
})

module.exports = router
```

### API ç‰ˆæœ¬æ§åˆ¶

```javascript
const express = require('express')
const app = express()

// v1 API
const v1Router = express.Router()
v1Router.get('/users', (req, res) => {
  res.json({ version: 'v1', users: [] })
})

// v2 API
const v2Router = express.Router()
v2Router.get('/users', (req, res) => {
  res.json({ version: 'v2', data: { users: [] } })
})

// æŒ‚è½½ç‰ˆæœ¬è·¯ç”±
app.use('/api/v1', v1Router)
app.use('/api/v2', v2Router)

// æˆ–è€…ä½¿ç”¨ Header ç‰ˆæœ¬æ§åˆ¶
app.use('/api', (req, res, next) => {
  const version = req.get('Accept-Version') || '1'
  req.apiVersion = version
  next()
})

app.get('/api/users', (req, res) => {
  if (req.apiVersion === '2') {
    res.json({ version: 'v2', data: { users: [] } })
  } else {
    res.json({ version: 'v1', users: [] })
  }
})
```

## éƒ¨ç½²

### ç”Ÿäº§ç¯å¢ƒé…ç½®

```javascript
const express = require('express')
const compression = require('compression')
const helmet = require('helmet')
const morgan = require('morgan')
const app = express()

// ä¿¡ä»»ä»£ç†ï¼ˆå¦‚æœåœ¨åå‘ä»£ç†åé¢ï¼‰
app.set('trust proxy', 1)

// å‹ç¼©å“åº”
app.use(compression())

// å®‰å…¨å¤´
app.use(helmet())

// æ—¥å¿—
if (process.env.NODE_ENV === 'production') {
  app.use(morgan('combined'))
} else {
  app.use(morgan('dev'))
}

// ç¦ç”¨ x-powered-by
app.disable('x-powered-by')

// è·¯ç”±
app.get('/', (req, res) => {
  res.send('Hello World')
})

// é”™è¯¯å¤„ç†
app.use((err, req, res, next) => {
  console.error(err.stack)
  res.status(500).send('Something broke!')
})

const port = process.env.PORT || 3000
app.listen(port, () => {
  console.log(`Server running on port ${port}`)
})
```

### PM2 é…ç½®

```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'myapp',
    script: 'app.js',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'development'
    },
    env_production: {
      NODE_ENV: 'production'
    }
  }]
}
```

```bash
# å¯åŠ¨
pm2 start ecosystem.config.js --env production

# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs

# é‡å¯
pm2 restart myapp

# åœæ­¢
pm2 stop myapp

# åˆ é™¤
pm2 delete myapp
```

### Docker é…ç½®

```dockerfile
# Dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./

RUN npm ci --only=production

COPY . .

EXPOSE 3000

USER node

CMD ["node", "app.js"]
```

```yaml
# docker-compose.yml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=mongodb://mongo:27017/myapp
    depends_on:
      - mongo

  mongo:
    image: mongo:latest
    volumes:
      - mongo-data:/data/db

volumes:
  mongo-data:
```

## æµ‹è¯•

### å•å…ƒæµ‹è¯•

```javascript
// tests/app.test.js
const request = require('supertest')
const app = require('../app')

describe('GET /', () => {
  it('responds with Hello World', async () => {
    const response = await request(app).get('/')
    expect(response.status).toBe(200)
    expect(response.text).toBe('Hello World')
  })
})

describe('GET /users', () => {
  it('responds with json', async () => {
    const response = await request(app)
      .get('/users')
      .set('Accept', 'application/json')

    expect(response.status).toBe(200)
    expect(response.type).toBe('application/json')
    expect(response.body).toHaveProperty('users')
  })
})

describe('POST /users', () => {
  it('creates a new user', async () => {
    const newUser = { name: 'John', email: 'john@example.com' }

    const response = await request(app)
      .post('/users')
      .send(newUser)
      .set('Accept', 'application/json')

    expect(response.status).toBe(201)
    expect(response.body.name).toBe(newUser.name)
    expect(response.body.email).toBe(newUser.email)
  })

  it('returns 400 for invalid data', async () => {
    const response = await request(app)
      .post('/users')
      .send({ name: '' })
      .set('Accept', 'application/json')

    expect(response.status).toBe(400)
  })
})
```

### é›†æˆæµ‹è¯•

```javascript
// tests/integration/api.test.js
const request = require('supertest')
const mongoose = require('mongoose')
const app = require('../../app')

beforeAll(async () => {
  await mongoose.connect(process.env.TEST_DATABASE_URL)
})

afterAll(async () => {
  await mongoose.connection.close()
})

beforeEach(async () => {
  await mongoose.connection.dropDatabase()
})

describe('User API', () => {
  describe('POST /api/users', () => {
    it('should create a user', async () => {
      const res = await request(app)
        .post('/api/users')
        .send({ name: 'Test User', email: 'test@test.com' })

      expect(res.status).toBe(201)
      expect(res.body.name).toBe('Test User')
    })
  })

  describe('GET /api/users/:id', () => {
    it('should get a user by id', async () => {
      const createRes = await request(app)
        .post('/api/users')
        .send({ name: 'Test User', email: 'test@test.com' })

      const res = await request(app)
        .get(`/api/users/${createRes.body._id}`)

      expect(res.status).toBe(200)
      expect(res.body.name).toBe('Test User')
    })
  })
})
```

## API å‚è€ƒ

### Application

```javascript
const express = require('express')
const app = express()

// é…ç½®
app.set('view engine', 'pug')
app.get('view engine') // è·å–é…ç½®

// ä¸­é—´ä»¶
app.use(middleware)
app.use('/path', middleware)

// è·¯ç”±
app.get(path, handler)
app.post(path, handler)
app.put(path, handler)
app.delete(path, handler)
app.all(path, handler)

// è·¯ç”±å‚æ•°
app.param(name, callback)

// è·¯ç”±å™¨
app.route(path)

// æŒ‚è½½
app.use(path, router)

// ç›‘å¬
app.listen(port, [hostname], [callback])
```

### Request

```javascript
// å±æ€§
req.app          // Express åº”ç”¨å®ä¾‹
req.baseUrl      // è·¯ç”±å™¨çš„åŸºç¡€ URL
req.body         // è¯·æ±‚ä½“
req.cookies      // Cookies
req.fresh        // æ˜¯å¦æ–°é²œ
req.hostname     // ä¸»æœºå
req.ip           // IP åœ°å€
req.ips          // IP åœ°å€æ•°ç»„
req.method       // HTTP æ–¹æ³•
req.originalUrl  // åŸå§‹ URL
req.params       // è·¯ç”±å‚æ•°
req.path         // è·¯å¾„
req.protocol     // åè®®
req.query        // æŸ¥è¯¢å‚æ•°
req.route        // å½“å‰è·¯ç”±
req.secure       // æ˜¯å¦ HTTPS
req.signedCookies // ç­¾å Cookies
req.stale        // æ˜¯å¦è¿‡æœŸ
req.subdomains   // å­åŸŸåæ•°ç»„
req.xhr          // æ˜¯å¦ XHR

// æ–¹æ³•
req.accepts(types)
req.acceptsCharsets(charset)
req.acceptsEncodings(encoding)
req.acceptsLanguages(lang)
req.get(field)
req.is(type)
req.range(size)
```

### Response

```javascript
// å±æ€§
res.app          // Express åº”ç”¨å®ä¾‹
res.headersSent  // æ˜¯å¦å·²å‘é€å¤´éƒ¨
res.locals       // æœ¬åœ°å˜é‡

// æ–¹æ³•
res.append(field, value)
res.attachment([filename])
res.cookie(name, value, [options])
res.clearCookie(name, [options])
res.download(path, [filename], [callback])
res.end([data], [encoding])
res.format(object)
res.get(field)
res.json([body])
res.jsonp([body])
res.links(links)
res.location(path)
res.redirect([status], path)
res.render(view, [locals], [callback])
res.send([body])
res.sendFile(path, [options], [callback])
res.sendStatus(statusCode)
res.set(field, [value])
res.status(code)
res.type(type)
res.vary(field)
```

### Router

```javascript
const router = express.Router([options])

// ä¸­é—´ä»¶
router.use([path], middleware)

// è·¯ç”±
router.get(path, handler)
router.post(path, handler)
router.put(path, handler)
router.delete(path, handler)
router.all(path, handler)

// å‚æ•°
router.param(name, callback)

// é“¾å¼è·¯ç”±
router.route(path)
```

## å¸¸è§é—®é¢˜

### å¤„ç†å¤§æ–‡ä»¶ä¸Šä¼ 

```javascript
const express = require('express')
const multer = require('multer')
const app = express()

const upload = multer({
  dest: 'uploads/',
  limits: {
    fileSize: 50 * 1024 * 1024 // 50MB
  }
})

app.post('/upload', upload.single('file'), (req, res) => {
  res.json({ file: req.file })
})

// å¤„ç†è¶…å¤§æ–‡ä»¶é”™è¯¯
app.use((err, req, res, next) => {
  if (err.code === 'LIMIT_FILE_SIZE') {
    return res.status(413).json({ error: 'File too large' })
  }
  next(err)
})
```

### ä¼˜é›…å…³é—­

```javascript
const express = require('express')
const app = express()

const server = app.listen(3000, () => {
  console.log('Server running')
})

process.on('SIGTERM', () => {
  console.log('SIGTERM signal received: closing HTTP server')
  server.close(() => {
    console.log('HTTP server closed')
    process.exit(0)
  })
})
```

### å¤„ç†æœªæ•è·å¼‚å¸¸

```javascript
process.on('uncaughtException', (err) => {
  console.error('Uncaught Exception:', err)
  process.exit(1)
})

process.on('unhandledRejection', (reason, promise) => {
  console.error('Unhandled Rejection at:', promise, 'reason:', reason)
})
```
